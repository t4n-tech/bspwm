#!/usr/bin/env bash
#
# install.sh - Automated installation script for BSPWM desktop environment on Void Linux
# FOKUS UTAMA: Memastikan D-Bus berfungsi dengan benar agar terminal dan polybar dapat berjalan.
#

set -e  # Exit immediately if a command exits with a non-zero status

# -----------------------------------------------------------------------------
# Color definitions
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }

if [[ $EUID -eq 0 ]]; then
    error "Jangan jalankan script ini sebagai root. Jalankan sebagai user biasa."
    exit 1
fi

# -----------------------------------------------------------------------------
# Variables
# -----------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOME_DIR="$HOME"
CONFIG_DIR="$HOME_DIR/.config"
FONTS_DIR="$HOME_DIR/.fonts"
ICONS_DIR="$HOME_DIR/.icons"
THEMES_DIR="$HOME_DIR/.themes"
LOCAL_BIN_DIR="$HOME_DIR/.local/bin"
CACHE_DIR="$HOME_DIR/.cache"

mkdir -p "$CONFIG_DIR" "$FONTS_DIR" "$ICONS_DIR" "$THEMES_DIR" "$LOCAL_BIN_DIR" "$CACHE_DIR"

# -----------------------------------------------------------------------------
# Package lists
# -----------------------------------------------------------------------------
PACKAGES_BASE=(
    xorg
    bspwm sxhkd
    rofi picom polybar alacritty dmenu feh
    network-manager-applet chromium xmirror
    Thunar gvfs gvfs-mtp thunar-archive-plugin thunar-media-tags-plugin
    brightnessctl xss-lock xfce4-terminal fontconfig
    playerctl lm_sensors htop btop fastfetch betterlockscreen
    i3lock-color xrdb firefox flameshot galculator geany timeshift
    lxappearance papirus-icon-theme gtk-engine-murrine arc-theme
    font-awesome nerd-fonts dejavu-fonts-ttf noto-fonts-ttf noto-fonts-cjk
    xdg-user-dirs
)

PACKAGES_PIPEWIRE=(
    pipewire wireplumber
    libspa-bluetooth
    alsa-pipewire
    libjack-pipewire
    pavucontrol pamixer
)

PACKAGES_SERVICES=(
    dbus
    elogind
    NetworkManager
    lightdm
    rtkit
    polkit
)

PACKAGES_ALL=(
    "${PACKAGES_BASE[@]}"
    "${PACKAGES_PIPEWIRE[@]}"
    "${PACKAGES_SERVICES[@]}"
)

# -----------------------------------------------------------------------------
# Install packages
# -----------------------------------------------------------------------------
install_packages() {
    info "Memperbarui sistem dan menginstal paket..."

    sudo xbps-install -Su xbps || { error "Gagal update xbps"; exit 1; }
    sudo xbps-install -y void-repo-multilib void-repo-multilib-nonfree void-repo-nonfree 2>/dev/null || warn "Repositori mungkin sudah ada."
    sudo xbps-install -Su || { error "Gagal update sistem"; exit 1; }

    for pkg in "${PACKAGES_ALL[@]}"; do
        if ! xbps-query "$pkg" >/dev/null 2>&1; then
            info "Menginstal $pkg..."
            sudo xbps-install -y "$pkg" || warn "Gagal menginstal $pkg"
        else
            info "Paket $pkg sudah terinstal, lewati."
        fi
    done
    success "Semua paket selesai."
}

# -----------------------------------------------------------------------------
# D-Bus: pastikan service berjalan dan user berada di grup dbus
# -----------------------------------------------------------------------------
setup_dbus() {
    info "Mengonfigurasi D-Bus..."

    # Tambahkan user ke grup dbus jika ada
    if getent group dbus >/dev/null; then
        if ! groups "$USER" | grep -q dbus; then
            sudo usermod -a -G dbus "$USER"
            warn "User ditambahkan ke grup 'dbus'. Anda HARUS logout dan login kembali agar efeknya berlaku."
        fi
    fi

    # Aktifkan service dbus
    if [[ -L /var/service/dbus ]]; then
        if sv status dbus | grep -q run; then
            info "Service dbus sudah berjalan."
        else
            sudo sv start dbus
        fi
    else
        if [[ -d /etc/sv/dbus ]]; then
            sudo ln -s /etc/sv/dbus /var/service/
            info "Service dbus diaktifkan."
        else
            error "Direktori service dbus tidak ditemukan. Apakah paket dbus sudah terinstal?"
        fi
    fi

    # dumb_runtime_dir untuk XDG_RUNTIME_DIR
    if ! command -v dumb_runtime_dir >/dev/null 2>&1; then
        sudo xbps-install -y dumb_runtime_dir
    fi
    if ! grep -q "pam_dumb_runtime_dir" /etc/pam.d/system-login 2>/dev/null; then
        echo "session optional pam_dumb_runtime_dir.so" | sudo tee -a /etc/pam.d/system-login >/dev/null
    fi

    success "Konfigurasi D-Bus selesai. (Ingat: logout/login setelah instalasi!)"
}

# -----------------------------------------------------------------------------
# Buat direktori user (Documents, Downloads, dll)
# -----------------------------------------------------------------------------
create_user_dirs() {
    info "Membuat direktori user standar..."
    if command -v xdg-user-dirs-update >/dev/null 2>&1; then
        xdg-user-dirs-update
    else
        mkdir -p "$HOME/Documents" "$HOME/Downloads" "$HOME/Pictures" \
                 "$HOME/Videos" "$HOME/Music" "$HOME/Desktop" \
                 "$HOME/Templates" "$HOME/Public"
    fi
    success "Direktori user siap."
}

# -----------------------------------------------------------------------------
# PipeWire
# -----------------------------------------------------------------------------
setup_pipewire() {
    info "Mengonfigurasi PipeWire..."
    mkdir -p "$CONFIG_DIR/pipewire/pipewire.conf.d"

    [[ -f /usr/share/examples/wireplumber/10-wireplumber.conf ]] && \
        ln -sf /usr/share/examples/wireplumber/10-wireplumber.conf "$CONFIG_DIR/pipewire/pipewire.conf.d/"
    [[ -f /usr/share/examples/pipewire/20-pipewire-pulse.conf ]] && \
        ln -sf /usr/share/examples/pipewire/20-pipewire-pulse.conf "$CONFIG_DIR/pipewire/pipewire.conf.d/"

    if [[ -d /usr/share/alsa/alsa.conf.d ]]; then
        sudo mkdir -p /etc/alsa/conf.d
        sudo ln -sf /usr/share/alsa/alsa.conf.d/50-pipewire.conf /etc/alsa/conf.d/
        sudo ln -sf /usr/share/alsa/alsa.conf.d/99-pipewire-default.conf /etc/alsa/conf.d/
    fi

    if [[ -d /usr/lib/pipewire-0.3/jack ]]; then
        echo "/usr/lib/pipewire-0.3/jack" | sudo tee /etc/ld.so.conf.d/pipewire-jack.conf >/dev/null
        sudo ldconfig
    fi

    mkdir -p "$CONFIG_DIR/autostart"
    [[ -f /usr/share/applications/pipewire.desktop ]] && \
        ln -sf /usr/share/applications/pipewire.desktop "$CONFIG_DIR/autostart/"
    [[ -f /usr/share/applications/pipewire-pulse.desktop ]] && \
        ln -sf /usr/share/applications/pipewire-pulse.desktop "$CONFIG_DIR/autostart/"

    sudo usermod -a -G audio,video "$USER"
    success "PipeWire dikonfigurasi."
}

# -----------------------------------------------------------------------------
# Betterlockscreen
# -----------------------------------------------------------------------------
setup_betterlockscreen() {
    info "Menyiapkan Betterlockscreen..."
    local wallpaper="$HOME/.config/bspwm/wallpaper/Sinon-2.jpg"
    if [[ -f "$wallpaper" ]]; then
        betterlockscreen -u "$wallpaper" --blur 0.8
    else
        warn "Wallpaper tidak ditemukan, lewati."
    fi
}

# -----------------------------------------------------------------------------
# Salin dotfiles dan lakukan penyesuaian kritis (D-Bus di bspwmrc)
# -----------------------------------------------------------------------------
copy_dotfiles() {
    info "Menyalin file konfigurasi..."

    # Salin folder config
    [[ -d "$SCRIPT_DIR/config" ]] && cp -r "$SCRIPT_DIR/config/"* "$CONFIG_DIR/"

    # Font, icons, themes
    [[ -d "$SCRIPT_DIR/fonts" ]] && cp -r "$SCRIPT_DIR/fonts/"* "$FONTS_DIR/" && fc-cache -fv "$FONTS_DIR" >/dev/null
    [[ -d "$SCRIPT_DIR/icons" ]] && cp -r "$SCRIPT_DIR/icons/"* "$ICONS_DIR/"
    [[ -d "$SCRIPT_DIR/themes" ]] && cp -r "$SCRIPT_DIR/themes/"* "$THEMES_DIR/"

    # Skrip tambahan
    [[ -d "$SCRIPT_DIR/other/pipewire" ]] && cp -r "$SCRIPT_DIR/other/pipewire"/* "$LOCAL_BIN_DIR/" && chmod +x "$LOCAL_BIN_DIR/"*
    [[ -f "$SCRIPT_DIR/other/.bashrc" ]] && cp "$SCRIPT_DIR/other/.bashrc" "$HOME_DIR/"

    # Konfigurasi sistem
    [[ -d "$SCRIPT_DIR/other/xorg.conf.d" ]] && sudo cp -r "$SCRIPT_DIR/other/xorg.conf.d" /etc/X11/
    [[ -f "$SCRIPT_DIR/other/resolv.conf" ]] && sudo cp "$SCRIPT_DIR/other/resolv.conf" /etc/
    [[ -d "$SCRIPT_DIR/other/root" ]] && sudo cp -r "$SCRIPT_DIR/other/root/.bashrc" /root/ 2>/dev/null || true

    # -------------------------------------------------------------------------
    # PERBAIKAN UTAMA: Pastikan bspwmrc menjalankan dbus-launch jika session belum ada
    # -------------------------------------------------------------------------
    local bspwmrc="$CONFIG_DIR/bspwm/bspwmrc"
    if [[ -f "$bspwmrc" ]]; then
        # Hapus baris dbus-launch lama jika ada (agar tidak dobel)
        sed -i '/dbus-launch/d' "$bspwmrc"
        # Tambahkan di awal (setelah shebang)
        sed -i '2 i\
# Inisialisasi session D-Bus jika belum ada (krusial untuk terminal & polybar)\
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then\
    eval "$(dbus-launch --sh-syntax --exit-with-session)"\
fi\
' "$bspwmrc"
        info "Baris dbus-launch telah ditambahkan ke bspwmrc."
    else
        warn "bspwmrc tidak ditemukan, buat manual nanti."
    fi

    # Picom: pastikan backend xrender (stabil)
    local picom_conf="$CONFIG_DIR/picom/picom.conf"
    if [[ -f "$picom_conf" ]]; then
        sed -i 's/^backend = "glx"/backend = "xrender"/' "$picom_conf" 2>/dev/null || true
    fi

    success "Dotfiles selesai disalin dan dimodifikasi."
}

# -----------------------------------------------------------------------------
# Aktifkan layanan runit
# -----------------------------------------------------------------------------
setup_services() {
    info "Mengaktifkan layanan sistem..."
    local services=(dbus elogind NetworkManager lightdm rtkit polkit)
    for svc in "${services[@]}"; do
        if [[ -d "/etc/sv/$svc" ]]; then
            [[ ! -L "/var/service/$svc" ]] && sudo ln -s "/etc/sv/$svc" /var/service/ && info "$svc diaktifkan"
        else
            warn "Layanan $svc tidak ditemukan."
        fi
    done
    success "Layanan diaktifkan."
}

# -----------------------------------------------------------------------------
# Konfigurasi tambahan (polkit, udev, group)
# -----------------------------------------------------------------------------
setup_additional() {
    info "Menambahkan konfigurasi tambahan..."

    # Polkit rule
    sudo mkdir -p /etc/polkit-1/rules.d
    sudo tee /etc/polkit-1/rules.d/10-bspwm.rules >/dev/null << 'EOF'
polkit.addRule(function(action, subject) {
    if ((action.id == "org.freedesktop.login1.reboot" ||
         action.id == "org.freedesktop.login1.power-off" ||
         action.id == "org.freedesktop.login1.suspend") &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
EOF

    # Groups
    sudo usermod -a -G audio,video,input,disk,wheel "$USER"

    # Backlight udev
    if [[ ! -w /sys/class/backlight/*/brightness ]] 2>/dev/null; then
        sudo tee /etc/udev/rules.d/90-backlight.rules >/dev/null << 'EOF'
ACTION=="add", SUBSYSTEM=="backlight", RUN+="/bin/chgrp video /sys/class/backlight/%k/brightness"
ACTION=="add", SUBSYSTEM=="backlight", RUN+="/bin/chmod g+w /sys/class/backlight/%k/brightness"
EOF
    fi

    # NetworkManager resolv.conf
    if [[ -f /etc/resolv.conf ]]; then
        sudo mkdir -p /etc/NetworkManager/conf.d
        echo -e "[main]\nrc-manager=unmanaged" | sudo tee /etc/NetworkManager/conf.d/rc-manager.conf >/dev/null
    fi

    success "Konfigurasi tambahan selesai."
}

# -----------------------------------------------------------------------------
# Pesan akhir
# -----------------------------------------------------------------------------
final_message() {
    echo ""
    echo -e "${GREEN}╔══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║         INSTALASI BSPWM PADA VOID LINUX SELESAI         ║${NC}"
    echo -e "${GREEN}╚══════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}‼️  LANGKAH PALING PENTING ‼️${NC}"
    echo -e "   ${CYAN}1. LOGOUT dari sesi saat ini (atau reboot).${NC}"
    echo -e "   ${CYAN}2. LOGIN kembali agar semua perubahan grup (dbus, audio, dll)生效.${NC}"
    echo ""
    echo -e "${BLUE}Setelah login:${NC}"
    echo -e "  • Cek D-Bus session:  ${CYAN}echo \$DBUS_SESSION_BUS_ADDRESS${NC}"
    echo -e "    Seharusnya terisi alamat seperti 'unix:path=/run/user/1000/bus'"
    echo -e "  • Jika kosong, kemungkinan display manager tidak memulai dbus."
    echo -e "    Namun bspwmrc sudah menyertakan fallback 'dbus-launch'."
    echo ""
    echo -e "  • Jalankan terminal (Alacritty / xfce4-terminal). Jika masih gagal,"
    echo -e "    buka TTY (Ctrl+Alt+F2) dan periksa log:"
    echo -e "    ${CYAN}tail -f ~/.config/bspwm/autostart.log${NC}"
    echo ""
    echo -e "  • Polybar seharusnya berjalan. Cek dengan: ${CYAN}pgrep polybar${NC}"
    echo -e "  • Jika tidak jalan, coba manual: ${CYAN}~/.config/polybar/launch.sh${NC}"
    echo ""
    echo -e "${GREEN}Terima kasih telah menggunakan script ini.${NC}"
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------
main() {
    info "Memulai instalasi BSPWM untuk Void Linux (fokus D-Bus)..."
    install_packages
    setup_dbus
    create_user_dirs
    setup_pipewire
    copy_dotfiles
    setup_services
    setup_additional
    setup_betterlockscreen
    final_message
}

main