#!/usr/bin/env bash
# volume-minimal.sh - Simple PipeWire volume control

# Settings
volume_step=5
max_volume=150

# Detect audio system
if command -v wpctl >/dev/null 2>&1; then
    # PipeWire
    get_volume() {
        wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -oE '[0-9]+\.[0-9]+' | head -1 | \
        awk '{print int($1 * 100)}'
    }
    
    set_volume() {
        wpctl set-volume @DEFAULT_AUDIO_SINK@ "$(echo "scale=2; $1 / 100" | bc)"
    }
    
    toggle_mute() {
        wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
    }
    
    get_mute() {
        wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q "MUTED" && echo "yes" || echo "no"
    }
else
    # PulseAudio fallback
    get_volume() {
        pactl get-sink-volume @DEFAULT_SINK@ | grep -Po '[0-9]{1,3}(?=%)' | head -1
    }
    
    set_volume() {
        pactl set-sink-volume @DEFAULT_SINK@ "$1%"
    }
    
    toggle_mute() {
        pactl set-sink-mute @DEFAULT_SINK@ toggle
    }
    
    get_mute() {
        pactl get-sink-mute @DEFAULT_SINK@ | grep -Po '(?<=Mute: )(yes|no)'
    }
fi

# Show notification
show_notif() {
    local vol=$(get_volume)
    local mute=$(get_mute)
    
    if [ "$mute" = "yes" ]; then
        icon="ðŸ”‡"
        text="Muted"
    elif [ "$vol" -eq 0 ]; then
        icon="ðŸ”‡"
        text="$vol%"
    elif [ "$vol" -lt 30 ]; then
        icon="ðŸ”ˆ"
        text="$vol%"
    elif [ "$vol" -lt 70 ]; then
        icon="ðŸ”‰"
        text="$vol%"
    else
        icon="ðŸ”Š"
        text="$vol%"
    fi
    
    notify-send -t 1000 "Volume" "$icon $text" -h string:x-canonical-private-synchronous:volume
}

# Handle commands
case "$1" in
    up)
        vol=$(get_volume)
        new_vol=$((vol + volume_step))
        [ "$new_vol" -gt "$max_volume" ] && new_vol=$max_volume
        set_volume "$new_vol"
        show_notif
        ;;
    down)
        vol=$(get_volume)
        new_vol=$((vol - volume_step))
        [ "$new_vol" -lt 0 ] && new_vol=0
        set_volume "$new_vol"
        show_notif
        ;;
    mute)
        toggle_mute
        show_notif
        ;;
    *)
        echo "Usage: $0 {up|down|mute}"
        exit 1
        ;;
esac