#!/usr/bin/env bash
#
# install.sh - Automated installation script for BSPWM desktop environment on Void Linux
# This script will install required packages, configure PipeWire, and deploy your dotfiles.
#

set -e  # Exit immediately if a command exits with a non-zero status

# -----------------------------------------------------------------------------
# Color definitions for pretty output
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------
info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }

# Check if running as root â€“ we don't want that for user parts
if [[ $EUID -eq 0 ]]; then
    error "This script should NOT be run as root. Run it as a normal user."
    exit 1
fi

# -----------------------------------------------------------------------------
# Variables
# -----------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOME_DIR="$HOME"
CONFIG_DIR="$HOME_DIR/.config"
FONTS_DIR="$HOME_DIR/.fonts"
ICONS_DIR="$HOME_DIR/.icons"
THEMES_DIR="$HOME_DIR/.themes"
LOCAL_BIN_DIR="$HOME_DIR/.local/bin"
CACHE_DIR="$HOME_DIR/.cache"

# Ensure required directories exist
mkdir -p "$CONFIG_DIR" "$FONTS_DIR" "$ICONS_DIR" "$THEMES_DIR" "$LOCAL_BIN_DIR" "$CACHE_DIR"

# -----------------------------------------------------------------------------
# Package lists (corrected: polkit, not polkitd)
# -----------------------------------------------------------------------------
PACKAGES_BASE=(
    xorg
    bspwm sxhkd
    rofi picom polybar alacritty dmenu feh
    network-manager-applet chromium xterm
    Thunar gvfs gvfs-mtp thunar-archive-plugin thunar-media-tags-plugin
    brightnessctl xss-lock xfce4-terminal fontconfig
    playerctl lm_sensors htop btop fastfetch betterlockscreen
    i3lock-color xrdb firefox flameshot galculator geany timeshift
    lxappearance papirus-icon-theme gtk-engine-murrine arc-theme
    font-awesome nerd-fonts dejavu-fonts-ttf noto-fonts-ttf noto-fonts-cjk
)

PACKAGES_PIPEWIRE=(
    pipewire wireplumber
    libspa-bluetooth
    alsa-pipewire
    libjack-pipewire
    pavucontrol pamixer
)

PACKAGES_SERVICES=(
    dbus elogind
    NetworkManager
    lightdm
    rtkit
    polkit
)

# Combine all packages
PACKAGES_ALL=(
    "${PACKAGES_BASE[@]}"
    "${PACKAGES_PIPEWIRE[@]}"
    "${PACKAGES_SERVICES[@]}"
)

# -----------------------------------------------------------------------------
# Install required packages using xbps (per-package to avoid total failure)
# -----------------------------------------------------------------------------
install_packages() {
    info "Updating system and installing packages..."

    sudo xbps-install -Su xbps || {
        error "Failed to update xbps"
        exit 1
    }

    # Add repositories (ignore errors if already added)
    sudo xbps-install -y void-repo-multilib void-repo-multilib-nonfree void-repo-nonfree || warn "Some repositories may already be added."

    sudo xbps-install -Su || {
        error "System update failed"
        exit 1
    }

    info "Installing packages one by one..."
    for pkg in "${PACKAGES_ALL[@]}"; do
        if ! xbps-query "$pkg" >/dev/null 2>&1; then
            info "Installing $pkg..."
            sudo xbps-install -y "$pkg" || warn "Failed to install $pkg"
        else
            info "Package $pkg already installed, skipping."
        fi
    done

    success "All packages installed (with possible warnings above)."
}

# -----------------------------------------------------------------------------
# Setup D-Bus: ensure service is running and user is in dbus group
# -----------------------------------------------------------------------------
setup_dbus() {
    info "Checking D-Bus configuration..."

    # Ensure user is in the 'dbus' group (if it exists)
    if getent group dbus >/dev/null; then
        if ! groups "$USER" | grep -q dbus; then
            sudo usermod -a -G dbus "$USER"
            info "User added to 'dbus' group. You may need to re-login for this to take effect."
        fi
    fi

    # Check if dbus service is enabled and running
    if [[ -L /var/service/dbus ]]; then
        if sv status dbus | grep -q run; then
            info "D-Bus service is running."
        else
            warn "D-Bus service is enabled but not running. Attempting to start..."
            sudo sv start dbus
        fi
    else
        warn "D-Bus service is not enabled. Enabling now..."
        if [[ -d /etc/sv/dbus ]]; then
            sudo ln -s /etc/sv/dbus /var/service/
            info "D-Bus service enabled. It may take a moment to start."
        else
            error "D-Bus service directory not found. Please install dbus."
        fi
    fi

    # Additional: ensure XDG_RUNTIME_DIR is set (dumb_runtime_dir should handle it)
    if [[ -z "$XDG_RUNTIME_DIR" ]] || [[ ! -d "$XDG_RUNTIME_DIR" ]]; then
        warn "XDG_RUNTIME_DIR is not set or does not exist. dumb_runtime_dir should handle this after login."
    fi

    success "D-Bus setup completed."
}

# -----------------------------------------------------------------------------
# Create standard user directories (Documents, Downloads, etc.)
# -----------------------------------------------------------------------------
create_user_dirs() {
    info "Creating standard user directories..."

    # Try using xdg-user-dirs-update if available
    if command -v xdg-user-dirs-update >/dev/null 2>&1; then
        xdg-user-dirs-update
        info "xdg-user-dirs-update executed."
    else
        warn "xdg-user-dirs not installed. Creating directories manually."
        # Manual creation of common directories
        mkdir -p "$HOME/Documents" "$HOME/Downloads" "$HOME/Pictures" \
                 "$HOME/Videos" "$HOME/Music" "$HOME/Desktop" \
                 "$HOME/Templates" "$HOME/Public"
    fi

    # Ensure .config/user-dirs.dirs exists (for compatibility)
    if [[ ! -f "$HOME/.config/user-dirs.dirs" ]]; then
        cat > "$HOME/.config/user-dirs.dirs" << 'EOF'
XDG_DESKTOP_DIR="$HOME/Desktop"
XDG_DOWNLOAD_DIR="$HOME/Downloads"
XDG_TEMPLATES_DIR="$HOME/Templates"
XDG_PUBLICSHARE_DIR="$HOME/Public"
XDG_DOCUMENTS_DIR="$HOME/Documents"
XDG_MUSIC_DIR="$HOME/Music"
XDG_PICTURES_DIR="$HOME/Pictures"
XDG_VIDEOS_DIR="$HOME/Videos"
EOF
        info "Created default .config/user-dirs.dirs"
    fi

    success "User directories created."
}

# -----------------------------------------------------------------------------
# Setup PipeWire according to Void Linux documentation
# -----------------------------------------------------------------------------
setup_pipewire() {
    info "Configuring PipeWire..."

    # 1. Create config directories
    mkdir -p "$CONFIG_DIR/pipewire/pipewire.conf.d"

    # 2. Enable WirePlumber session manager
    if [[ -f /usr/share/examples/wireplumber/10-wireplumber.conf ]]; then
        ln -sf /usr/share/examples/wireplumber/10-wireplumber.conf \
            "$CONFIG_DIR/pipewire/pipewire.conf.d/"
        info "WirePlumber enabled"
    else
        warn "WirePlumber example config not found. Is wireplumber installed?"
    fi

    # 3. Enable PulseAudio interface
    if [[ -f /usr/share/examples/pipewire/20-pipewire-pulse.conf ]]; then
        ln -sf /usr/share/examples/pipewire/20-pipewire-pulse.conf \
            "$CONFIG_DIR/pipewire/pipewire.conf.d/"
        info "PipeWire PulseAudio interface enabled"
    else
        warn "PipeWire Pulse example config not found."
    fi

    # 4. ALSA integration
    if [[ -d /usr/share/alsa/alsa.conf.d ]]; then
        sudo mkdir -p /etc/alsa/conf.d
        sudo ln -sf /usr/share/alsa/alsa.conf.d/50-pipewire.conf /etc/alsa/conf.d/
        sudo ln -sf /usr/share/alsa/alsa.conf.d/99-pipewire-default.conf /etc/alsa/conf.d/
        info "ALSA integration configured"
    fi

    # 5. JACK integration (optional)
    if [[ -d /usr/lib/pipewire-0.3/jack ]]; then
        echo "/usr/lib/pipewire-0.3/jack" | sudo tee /etc/ld.so.conf.d/pipewire-jack.conf >/dev/null
        sudo ldconfig
        info "JACK integration configured"
    fi

    # 6. Ensure XDG_RUNTIME_DIR is set (dumb_runtime_dir)
    if ! command -v dumb_runtime_dir >/dev/null 2>&1; then
        info "Installing dumb_runtime_dir to manage XDG_RUNTIME_DIR..."
        sudo xbps-install -y dumb_runtime_dir
    fi

    # Ensure pam module is enabled (optional but recommended)
    if ! grep -q "pam_dumb_runtime_dir" /etc/pam.d/system-login 2>/dev/null; then
        echo "session optional pam_dumb_runtime_dir.so" | sudo tee -a /etc/pam.d/system-login >/dev/null
        info "pam_dumb_runtime_dir added to system-login"
    fi

    # 7. Autostart PipeWire and PipeWire-Pulse via desktop entries
    mkdir -p "$CONFIG_DIR/autostart"
    if [[ -f /usr/share/applications/pipewire.desktop ]]; then
        ln -sf /usr/share/applications/pipewire.desktop "$CONFIG_DIR/autostart/"
    fi
    if [[ -f /usr/share/applications/pipewire-pulse.desktop ]]; then
        ln -sf /usr/share/applications/pipewire-pulse.desktop "$CONFIG_DIR/autostart/"
    fi
    info "PipeWire autostart configured"

    # 8. Add user to audio/video groups (required when not using elogind)
    sudo usermod -a -G audio,video "$USER"

    success "PipeWire setup completed."
}

# ----------------------------------------------------------------------------
# Betterlockscreen Setup
# ----------------------------------------------------------------------------
setup_betterlockscreen() {
    info "Configuring Betterlockscreen..."
    betterlockscreen -u ~/.config/bspwm/wallpaper/Sinon-2.jpg --blur 0.8
}

# -----------------------------------------------------------------------------
# Copy dotfiles to their destinations
# -----------------------------------------------------------------------------
copy_dotfiles() {
    info "Copying configuration files..."

    # 1. Config directories
    if [[ -d "$SCRIPT_DIR/config" ]]; then
        cp -r "$SCRIPT_DIR/config/"* "$CONFIG_DIR/"
        info "Config files copied to $CONFIG_DIR"
    else
        warn "config directory not found. Skipping."
    fi

    # 2. Fonts
    if [[ -d "$SCRIPT_DIR/fonts" ]]; then
        cp -r "$SCRIPT_DIR/fonts/"* "$FONTS_DIR/"
        info "Fonts copied to $FONTS_DIR"
        # Update font cache
        fc-cache -fv "$FONTS_DIR" >/dev/null
    else
        warn "fonts directory not found. Skipping."
    fi

    # 3. Icons
    if [[ -d "$SCRIPT_DIR/icons" ]]; then
        cp -r "$SCRIPT_DIR/icons/"* "$ICONS_DIR/"
        info "Icons copied to $ICONS_DIR"
    else
        warn "icons directory not found. Skipping."
    fi

    # 4. Themes
    if [[ -d "$SCRIPT_DIR/themes" ]]; then
        cp -r "$SCRIPT_DIR/themes/"* "$THEMES_DIR/"
        info "Themes copied to $THEMES_DIR"
    else
        warn "themes directory not found. Skipping."
    fi

    # 5. Other user configs (pipewire scripts, bashrc)
    if [[ -d "$SCRIPT_DIR/other/pipewire" ]]; then
        cp -r "$SCRIPT_DIR/other/pipewire"/* "$LOCAL_BIN_DIR/"
        chmod +x "$LOCAL_BIN_DIR"/* 2>/dev/null || true
        info "PipeWire helper scripts copied to $LOCAL_BIN_DIR"
    fi

    if [[ -f "$SCRIPT_DIR/other/.bashrc" ]]; then
        cp "$SCRIPT_DIR/other/.bashrc" "$HOME_DIR/"
        info "Custom .bashrc copied"
    fi

    # 6. System-wide configurations (need sudo)
    if [[ -d "$SCRIPT_DIR/other/xorg.conf.d" ]]; then
        sudo cp -r "$SCRIPT_DIR/other/xorg.conf.d" /etc/X11/
        info "Xorg configuration copied to /etc/X11/xorg.conf.d"
    fi

    if [[ -f "$SCRIPT_DIR/other/resolv.conf" ]]; then
        sudo cp "$SCRIPT_DIR/other/resolv.conf" /etc/
        info "resolv.conf copied to /etc"
    fi

    if [[ -d "$SCRIPT_DIR/other/root" ]]; then
        sudo cp -r "$SCRIPT_DIR/other/root/.bashrc" /root/ 2>/dev/null || true
        info "Root .bashrc copied"
    fi

    success "All dotfiles deployed."
}

# -----------------------------------------------------------------------------
# Enable system services using runit
# -----------------------------------------------------------------------------
setup_services() {
    info "Enabling system services..."

    local services=(
        dbus
        elogind
        NetworkManager
        lightdm
        rtkit
        polkit
    )

    for svc in "${services[@]}"; do
        if [[ -d "/etc/sv/$svc" ]]; then
            if [[ ! -L "/var/service/$svc" ]]; then
                sudo ln -s "/etc/sv/$svc" /var/service/
                info "Service $svc enabled"
            else
                info "Service $svc already enabled"
            fi
        else
            warn "Service directory for $svc not found in /etc/sv"
        fi
    done

    success "Services enabled."
}

# -----------------------------------------------------------------------------
# Additional system configurations (polkit, udev, groups)
# -----------------------------------------------------------------------------
setup_additional() {
    info "Applying additional system tweaks..."

    # 1. Polkit rule for power management
    sudo mkdir -p /etc/polkit-1/rules.d
    cat | sudo tee /etc/polkit-1/rules.d/10-bspwm.rules >/dev/null << 'EOF'
polkit.addRule(function(action, subject) {
    if ((action.id == "org.freedesktop.login1.reboot" ||
         action.id == "org.freedesktop.login1.power-off" ||
         action.id == "org.freedesktop.login1.suspend") &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
EOF
    info "Polkit rule added for wheel group"

    # 2. Ensure user is in necessary groups (already in audio,video from pipewire, but add more)
    sudo usermod -a -G audio,video,input,disk,wheel "$USER"
    info "User added to audio,video,input,disk,wheel groups"

    # 3. udev rule for backlight control
    if [[ ! -w /sys/class/backlight/*/brightness ]] 2>/dev/null; then
        cat | sudo tee /etc/udev/rules.d/90-backlight.rules >/dev/null << 'EOF'
ACTION=="add", SUBSYSTEM=="backlight", RUN+="/bin/chgrp video /sys/class/backlight/%k/brightness"
ACTION=="add", SUBSYSTEM=="backlight", RUN+="/bin/chmod g+w /sys/class/backlight/%k/brightness"
EOF
        info "Backlight udev rule added"
    fi

    # 4. Configure NetworkManager not to manage resolv.conf (if we provided our own)
    if [[ -f /etc/resolv.conf ]]; then
        sudo mkdir -p /etc/NetworkManager/conf.d
        echo -e "[main]\nrc-manager=unmanaged" | sudo tee /etc/NetworkManager/conf.d/rc-manager.conf >/dev/null
        info "NetworkManager configured not to manage resolv.conf"
    fi

    success "Additional setup complete."
}

# -----------------------------------------------------------------------------
# Main function
# -----------------------------------------------------------------------------
main() {
    info "Starting BSPWM installation for Void Linux..."

    install_packages
    setup_dbus
    create_user_dirs
    setup_pipewire
    copy_dotfiles
    setup_services
    setup_additional
    setup_betterlockscreen

    success "Installation finished!"
    echo -e "${CYAN}Please reboot or restart your session to apply all changes.${NC}"
    echo -e "${YELLOW}Note: You may need to log out and back in for group changes to take effect.${NC}"
}

# Run main function
main